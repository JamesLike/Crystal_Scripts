Use XtalView to scale light to dark and calculate difference maps. 

Input:
PDB: structure refined against room T Laue data
HbI_2.1_refmac7.pdb

Data:
HbI_off_3sig.hkl 
HbI_100ps_3sig.hkl 
HbI_1ns_3sig.hkl

====================

Phase dark data:


******** only on SGIs *************

awk '{print $1,$2,$3,$4,$5,"0.0"}' HbI_off_3sig.hkl > HbI_off6.hkl
stfact HbI_2.1_refmac7.pdb HbI_off6.hkl HbI_off6.phs

Look for R-factor (agreement between Fdark and Fcalc) - for good data it is <20%. 

********* for Linux machines ****************

awk '{print $1,$2,$3,$4,"0.0","0.0"}' HbI_off_3sig.hkl > HbI_off.tmp.phs

Run Xfit (XtalView program):
- Make sure proper crystal file is loaded
- Under "Files", while cursor is on "Input PDB" line, click on pdb file name on the right side list, click on Load Model (loads the model as number 1)
- Under "Files", while cursor on "Map file", click on HbI_off.tmp.phs on the list on the right; then click on "Load/write Map"; in the new window that apepars chose Fo, then Apply
- Go to the main Xfit window, click on "SFCalc"; make sure pdb and *tmp.phs are listed as model and map files; click on "Calculate all and scale"
- Go to "Files" window, on "Map File" - select number 1, change name to HbI_off.phs; right-click on "Load/write Map", select "Save phases" 

=> Output:
HbI_off.phs
Format: h,k,l, Fdark, Fcalc, phase

Look for R-factor (agreement between Fdark and Fcalc) - for good data it is <20%. 

*********************************************************

We will use this HbI_off.phs output file just for phases and Fcalc as this scaling did not include B factor scaling.

====================================

Scale dark Fs to absolute F_cs (bin scaling so select the number of bins you want in xmerge):

awk '{print $1,$2,$3,$4,$5,"0.0"}' HbI_off_3sig.hkl > HbI_off6.hkl (output format: h,k,l,F_dark, sigF_dark, 0)

awk '{print $1,$2,$3,$5,"0.0","0.0","9999.9"}' HbI_off.phs > tmp1 (tmp1 format: h,k,l, Fcalc, 0,0,9999.9)
awk '{print $1,$2,$3,$4,$5,"0.0","9999.9"}' HbI_off6.hkl > tmp2 (tmp2 format: h,k,l,F_dark, sigF_dark, 0,9999.9)

(these "fin" formats are required by xmerge) 

Run:
xmerge

Input tmp1 and tmp2 as fin1 and fin2 files
output file: tmp3
Click "Scale" 
Quit

awk '{print $1,$2,$3,$8,$9,"0.0"}' tmp3 > HbI_off_as6.hkl

Output - dark Fs on absolute (Fcalc) scale:
HbI_off_as6.hkl
Format: h,k,l,F_dark_abs, sig_F, 0

=====================================

Delete tmp files.

Scale Flight to Fdark-abs:

100ps 

awk '{print $1,$2,$3,$4,$5,"0.0","9999.9"}' HbI_off_as6.hkl > tmp1
awk '{print $1,$2,$3,$4,$5,"0.0","9999.9"}' HbI_100ps_3sig.hkl > tmp2

Run:
xmerge

Input tmp1 and tmp2 as fin 1 and fin2 files
output file: tmp3
Click "Scale" 
Quit

awk '{print $1,$2,$3,$8,$9,"0.0"}' tmp3 > HbI_100ps_as6.hkl

Output - light Fs on absolute (Fcalc) scale, scaled to Fdark_abs:
HbI_100ps_as6.hkl
Format: h,k,l,F_light_abs, sig_F, 0

=====================================

Difference phase file (unweighted): you can use a script like diffmaps.mtf to match/combine apropriate (h,k,l)s of light, dark and phase file. 

diffmaps.mtf HbI_100ps_as6.hkl HbI_off_as6.hkl HbI_off.phs 100ps-dark_as.phs

First 3 file names are input files, 4th is the output file.
Output file format:
h,k,l,Flight,Fdark,phase

=====================================

Weighted difference maps:

Edit wmap.inp file - lists 3 input files (dark and light Fs on absolute scale and the phase file) and output file:
100ps_off_HbI_w.phs 

wmap.inp:
HbI_100ps_as6.hkl
HbI_off_as6.hkl
HbI_off.phs
100ps-dark_HbI_as.w.phs 

Run Marius' weight_zv2 program:

weight_zv2_linux < wmap.inp

FIRST  DATA SET (REFERENCE)    :  HbI_100ps_as6.hkl                                         
SECOND DATA SET                :  HbI_off_as6.hkl                                           
PHASES DATA SET                :  HbI_off.phs                                              
DIFFERENCE F AND WEIGHT OUTPUT :  100ps-dark_HbI_as.w.phs                                      
 NUMBER OF HKL IN FILE1             :      16232
 NUMBER OF HKL IN FILE2             :      17491
 NUMBER OF PHASES IN FILE3          :      17491
 NUMBER OF MATCHING HKL             :      16232
 NUMBER OF DIFFERENCE-F WRITTEN OUT :      16232
 MEAN AMPLITUDE DIFFERENCE                      :     -0.1347E-03
 MEAN AMPLITUDE DIFFERENCE/<WEIGHT>          (M):     -0.0002
 MEAN AMPLITUDE DIFFERENCE SQUARED              :      0.1814E-07
 MEAN ABSOLUTE AMPLITUDE DIFFERENCE             :     12.7330
 MEAN ABSOLUTE AMPLITUDE DIFFERENCE SQUARED  (Z):    162.1303
 MEAN SQUARE AMPLITUDE DIFFERENCE            (M):    450.4462
 MEAN SIGMA OF DIFFERENCE AMPLITUDES            :      6.0974
 MEAN SIGMA OF DIFFERENCE AMPLITUDES SQUARED (Z):     37.1779
 MEAN SQUARE SIGMA OF DIFFERENCE AMPLITUDES  (M):     64.4344
 AVERAGE WEIGHT                              (M):      0.5722
 AVERAGE ZHONG WEIGHT                        (Z):      0.4311

Output phase file:
100ps-dark_HbI_as.w.phs 

Format: h,k,l, delF, w_delF, phase
(delFs are on absolute scale)

====================

Use XtalView to check the maps:
input proper crystal, pdb file and phase file *phs 

For 100ps-dark_as.phs phase file (format: h,k,l,Flight,Fdark,phase) you need to chose Fo-Fc option. This produces unweighted difference map.
For 100ps-dark_HbI_as.w.phs phase  (format: h,k,l, delF, w_delF, phase) you need to chose Fo*fom option. This will multiply delF by w_delF from the input file and calculated  weighted difference maps.  

 